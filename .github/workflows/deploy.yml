name: Deploy Go App to Production

on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted
    defaults:
      run:
        shell: cmd
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create build directory
        run: mkdir build

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build Go binary
        run: |
          @echo off
          if not exist main.go (
            echo ‚ùå –§–∞–π–ª main.go –Ω–µ –Ω–∞–π–¥–µ–Ω!
            exit /b 1
          )
          set GOOS=linux
          set GOARCH=amd64
          go build -o build\goapp main.go
          dir build
          
      - name: Setup SSH
        run: |
          @echo off
          mkdir "%USERPROFILE%\.ssh"
          echo %SSH_PRIVATE_KEY% > "%USERPROFILE%\.ssh\id_ed25519"
          echo ‚úÖ –ö–ª—é—á –∑–∞–ø–∏—Å–∞–Ω
          icacls "%USERPROFILE%\.ssh\id_ed25519" /inheritance:r /grant:r "%USERNAME%":R
          echo ‚úÖ –ü—Ä–∞–≤–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
          
          :: –£–¥–∞–ª–µ–Ω–∏–µ CRLF –∏–∑ –∫–ª—é—á–∞ (–∞–Ω–∞–ª–æ–≥ sed -i)
          powershell -Command "(Get-Content '%USERPROFILE%\.ssh\id_ed25519') -replace \"`r`n\", \"`n\" | Set-Content '%USERPROFILE%\.ssh\id_ed25519' -NoNewline"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to Production
        run: |
          @echo off
          echo üöÄ –ö–æ–ø–∏—Ä—É–µ–º Go-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥...
          scp -P 5692 -i "%USERPROFILE%\.ssh\id_ed25519" -o StrictHostKeyChecking=no build\goapp %PROD_USER%@%PROD_HOST%:~/goapp
        env:
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_HOST: ${{ secrets.PROD_HOST }}

      - name: Start Application on Production
        run: |
          @echo off
          echo ‚öôÔ∏è –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Go-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...
          ssh -p 5692 -i "%USERPROFILE%\.ssh\id_ed25519" -o StrictHostKeyChecking=no %PROD_USER%@%PROD_HOST% "
            taskkill /f /im goapp.exe || true
            chmod +x ~/goapp
            start /b goapp > goapp.log 2>&1
            timeout /t 2 >nul
            tasklist | findstr goapp && echo ‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ || echo ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
          "
        env:
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_HOST: ${{ secrets.PROD_HOST }}

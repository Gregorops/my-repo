name: Deploy Go App to Production

on:
  workflow_dispatch:  # Запуск вручную по кнопке

jobs:
  build-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'  # Укажи свою версию Go, если нужна другая

      - name: Build Go binary
        run: |
          mkdir -p build
          if [ ! -f main.go ]; then
            echo "❌ Файл main.go не найден!"
            exit 1
          fi
          GOOS=linux GOARCH=amd64 go build -o build/goapp main.go
          ls -lh build/

      - name: Setup SSH
        run: |
           set -ex  # Показывает команды и останавливает при ошибке
           mkdir -p ~/.ssh
           echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
           echo "✅ Ключ записан"
           chmod 600 ~/.ssh/id_ed25519
           echo "✅ Права установлены"
           
      - name: Deploy to Production
        run: |
          echo "🚀 Копируем Go-приложение на прод..."
          scp -P 5692 -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no build/goapp "${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:/home/${{ secrets.PROD_USER }}/goapp"

      - name: Start Application on Production
        run: |
          echo "⚙️ Перезапуск Go-приложения..."
          ssh -p 5692 -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} "
            pkill goapp || true
            chmod +x ~/goapp
            nohup ~/goapp > ~/goapp.log 2>&1 &
            echo '✅ Приложение запущено'
          "

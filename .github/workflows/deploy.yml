name: Deploy Go App to Production

on:
  workflow_dispatch:  # Ð—Ð°Ð¿ÑƒÑÐº Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¿Ð¾ ÐºÐ½Ð¾Ð¿ÐºÐµ

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'  # Ð£ÐºÐ°Ð¶Ð¸ ÑÐ²Ð¾ÑŽ Ð²ÐµÑ€ÑÐ¸ÑŽ Go, ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð° Ð´Ñ€ÑƒÐ³Ð°Ñ

      - name: Build Go binary
        run: |
          mkdir -p build
          if [ ! -f main.go ]; then
            echo "âŒ Ð¤Ð°Ð¹Ð» main.go Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½!"
            exit 1
          fi
          GOOS=linux GOARCH=amd64 go build -o build/goapp main.go
          ls -lh build/

      - name: Setup SSH key and known_hosts
        run: |
          set -e
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # ÐŸÑ€Ð¾Ð²ÐµÑ€Ð¸Ð¼ Ñ‡Ñ‚Ð¾ ÐºÐ»ÑŽÑ‡ Ð·Ð°Ð¿Ð¸ÑÐ°Ð»ÑÑ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾
          echo "ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° SSH-ÐºÐ»ÑŽÑ‡Ð°:"
          head -n 2 ~/.ssh/id_ed25519 || echo "âš ï¸ ÐšÐ»ÑŽÑ‡ Ð½Ðµ Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½"

          # Ð”Ð¾Ð±Ð°Ð²Ð¸Ð¼ fingerprint ÑÐµÑ€Ð²ÐµÑ€Ð° Ð² known_hosts
          ssh-keyscan -p 5692 -H "${{ secrets.PROD_HOST }}" >> ~/.ssh/known_hosts

      - name: Deploy to Production
        run: |
          echo "ðŸš€ ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Go-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ð° Ð¿Ñ€Ð¾Ð´..."
          scp -P 5692 -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no build/goapp ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }}:/home/${{ secrets.PROD_USER }}/goapp

      - name: Start Application on Production
        run: |
          echo "âš™ï¸ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Go-Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ..."
          ssh -p 5692 -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no ${{ secrets.PROD_USER }}@${{ secrets.PROD_HOST }} "
            pkill goapp || true
            chmod +x ~/goapp
            nohup ~/goapp > ~/goapp.log 2>&1 &
            echo 'âœ… ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð¾'
          "

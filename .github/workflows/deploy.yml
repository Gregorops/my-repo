name: Deploy Go App to Production

on:
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: self-hosted  # Windows runner
    defaults:
      run:
        shell: powershell  # –ò—Å–ø–æ–ª—å–∑—É–µ–º PowerShell –¥–ª—è –ª—É—á—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏
        working-directory: ${{ github.workspace }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build Go binary
        run: |
          if (-not (Test-Path main.go)) {
            Write-Output "‚ùå –§–∞–π–ª main.go –Ω–µ –Ω–∞–π–¥–µ–Ω!"
            exit 1
          }
          $env:GOOS = "linux"
          $env:GOARCH = "amd64"
          go build -o build/app main.go
          Get-ChildItem build

      - name: Setup SSH
        run: |
          New-Item -ItemType Directory -Force -Path "$env:USERPROFILE\.ssh"
          $env:SSH_PRIVATE_KEY | Out-File -FilePath "$env:USERPROFILE\.ssh\id_ed25519" -Encoding ASCII
          Write-Output "‚úÖ SSH key created"
          # Fix line endings
          (Get-Content "$env:USERPROFILE\.ssh\id_ed25519") -replace "`r`n","`n" | Set-Content "$env:USERPROFILE\.ssh\id_ed25519" -NoNewline
          # Set permissions
          icacls "$env:USERPROFILE\.ssh\id_ed25519" /inheritance:r /grant:r "$env:USERNAME`:R"
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to Production
        run: |
          Write-Output "üöÄ Deploying to production..."
          scp -P 5692 -i "$env:USERPROFILE\.ssh\id_ed25519" -o StrictHostKeyChecking=no build/app ${env:PROD_USER}@${env:PROD_HOST}:/home/${env:PROD_USER}/app
        env:
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_HOST: ${{ secrets.PROD_HOST }}

      - name: Start Application on Production
        run: |
          Write-Output "‚öôÔ∏è Restarting application..."
          $commands = @"
            pgrep -f app | xargs kill -9 || true
            chmod +x /home/${env:PROD_USER}/app
            nohup /home/${env:PROD_USER}/app > /home/${env:PROD_USER}/app.log 2>&1 &
            sleep 2
            pgrep -f app && echo "‚úÖ Application started (PID: $(pgrep -f app))" || echo "‚ùå Failed to start application"
          "@
          ssh -p 5692 -i "$env:USERPROFILE\.ssh\id_ed25519" -o StrictHostKeyChecking=no ${env:PROD_USER}@${env:PROD_HOST} "$commands"
        env:
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_HOST: ${{ secrets.PROD_HOST }}
